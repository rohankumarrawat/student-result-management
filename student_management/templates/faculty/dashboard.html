{% extends 'base.html' %}

{% block title %}Faculty Dashboard - SRS{% endblock %}
{% block page_title %}Faculty Dashboard{% endblock %}

{% block sidebar_menu %}
<a href="{% url 'faculty_dashboard' %}" class="sidebar-link active">
    <i class="bi bi-speedometer2"></i> Dashboard
</a>
<a href="#subjectsSection" class="sidebar-link">
    <i class="bi bi-journal-text"></i> My Subjects
</a>
<a href="#studentsSection" class="sidebar-link">
    <i class="bi bi-people"></i> Students
</a>
{% endblock %}

{% block content %}

<!-- Top Stats -->
<div class="row g-4 mb-4">
    <div class="col-md-4">
        <div class="stat-card bg-white h-100">
            <div class="stat-icon" style="background:rgba(99,102,241,0.12);">
                <i class="bi bi-book-fill" style="color:#6366f1;"></i>
            </div>
            <div class="stat-value">{{ subjects|length }}</div>
            <div class="stat-label">Assigned Subjects</div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="stat-card bg-white h-100">
            <div class="stat-icon" style="background:rgba(34,197,94,0.12);">
                <i class="bi bi-people-fill" style="color:#22c55e;"></i>
            </div>
            <div class="stat-value">{{ results|length }}</div>
            <div class="stat-label">Total Results</div>
        </div>
    </div>
    <div class="col-md-4">
        {% if top_student %}
        <div class="stat-card h-100" style="background:linear-gradient(135deg,#f59e0b,#ef4444);">
            <div class="stat-icon" style="background:rgba(255,255,255,0.2);">
                <i class="bi bi-trophy-fill text-white"></i>
            </div>
            <div class="stat-value text-white">{{ top_student.student.user.first_name }}</div>
            <div class="stat-label text-white opacity-75">Class Topper · {{ top_student.marks }} marks</div>
        </div>
        {% else %}
        <div class="stat-card bg-white h-100">
            <div class="stat-icon" style="background:rgba(245,158,11,0.12);">
                <i class="bi bi-trophy-fill" style="color:#f59e0b;"></i>
            </div>
            <div class="stat-value">—</div>
            <div class="stat-label">Class Topper</div>
        </div>
        {% endif %}
    </div>
</div>

<div class="row g-4">
    <!-- Class Performance Chart -->
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header">
                <i class="bi bi-bar-chart-line me-2" style="color:#6366f1;"></i>Class Average by Subject
            </div>
            <div class="card-body">
                <canvas id="classChart" height="200"></canvas>
            </div>
        </div>
    </div>

    <!-- My Subjects -->
    <div class="col-lg-4" id="subjectsSection">
        <div class="card h-100">
            <div class="card-header">
                <i class="bi bi-journal-text me-2" style="color:#6366f1;"></i>My Subjects
            </div>
            <div class="card-body">
                {% for subject in subjects %}
                <div class="d-flex align-items-center gap-3 mb-3 p-3 rounded-3" style="background:#f8fafc;">
                    <div
                        style="width:40px;height:40px;border-radius:12px;background:rgba(99,102,241,0.1);color:#6366f1;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:0.8rem;flex-shrink:0;">
                        {{ subject.code|slice:":2" }}
                    </div>
                    <div>
                        <div class="fw-600" style="font-size:0.875rem;">{{ subject.name }}</div>
                        <small class="text-muted">{{ subject.code }}</small>
                    </div>
                </div>
                {% empty %}
                <div class="text-center text-muted py-4">
                    <i class="bi bi-journal-x fs-2 d-block mb-2"></i>No subjects assigned.
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<!-- Student Results Table -->
<div class="card mt-4" id="studentsSection">
    <div class="card-header">
        <i class="bi bi-table me-2" style="color:#6366f1;"></i>Student Results
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table">
                <thead>
                    <tr>
                        <th>Student</th>
                        <th>Roll No</th>
                        <th>Subject</th>
                        <th>Marks</th>
                        <th>Grade</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>
                    {% for result in results %}
                    <tr>
                        <td>
                            <div class="d-flex align-items-center gap-2">
                                <div
                                    style="width:32px;height:32px;border-radius:50%;background:rgba(99,102,241,0.1);color:#6366f1;display:flex;align-items:center;justify-content:center;font-weight:600;font-size:0.8rem;flex-shrink:0;">
                                    {{ result.student.user.first_name|slice:":1"|upper }}
                                </div>
                                <strong>{{ result.student.user.first_name }}</strong>
                            </div>
                        </td>
                        <td><span class="badge badge-soft-primary">{{ result.student.roll_number }}</span></td>
                        <td>{{ result.subject.name }}</td>
                        <td>
                            <strong
                                class="{% if result.marks >= 75 %}text-success{% elif result.marks >= 50 %}text-warning{% else %}text-danger{% endif %}">
                                {{ result.marks }}
                            </strong>/100
                        </td>
                        <td>
                            {% if result.marks >= 90 %}<span class="badge badge-soft-success">A+</span>
                            {% elif result.marks >= 75 %}<span class="badge badge-soft-success">A</span>
                            {% elif result.marks >= 60 %}<span class="badge badge-soft-primary">B</span>
                            {% elif result.marks >= 50 %}<span class="badge badge-soft-warning">C</span>
                            {% else %}<span class="badge badge-soft-danger">F</span>{% endif %}
                        </td>
                        <td>
                            {% if result.marks >= 50 %}
                            <span class="badge badge-soft-success"><i class="bi bi-check-circle me-1"></i>Pass</span>
                            {% else %}
                            <span class="badge badge-soft-danger"><i class="bi bi-x-circle me-1"></i>Fail</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="6" class="text-center py-5 text-muted">
                            <i class="bi bi-inbox fs-1 d-block mb-2"></i>No results found.
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    const subjectLabels = [{% for s in subjects %}"{{ s.name }}"{% if not forloop.last %}, {% endif %} {% endfor %}];
    const avgData = [{% for avg in class_averages %}{ { avg |default: "0" } } {% if not forloop.last %}, {% endif %} {% endfor %}];

    if (subjectLabels.length > 0) {
        const ctx = document.getElementById('classChart').getContext('2d');
        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: subjectLabels,
                datasets: [{
                    label: 'Class Avg',
                    data: avgData,
                    backgroundColor: 'rgba(99,102,241,0.75)',
                    borderRadius: 8,
                    borderSkipped: false,
                }]
            },
            options: {
                responsive: true,
                plugins: { legend: { display: false } },
                scales: {
                    y: { beginAtZero: true, max: 100, grid: { color: '#f1f5f9' } },
                    x: { grid: { display: false } }
                }
            }
        });
    }
</script>
{% endblock %}