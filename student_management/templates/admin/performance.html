{% extends 'base.html' %}

{% block title %}Performance Analytics - SRS{% endblock %}
{% block page_title %}Performance Analytics{% endblock %}

{% block sidebar_menu %}
<a href="{% url 'admin_dashboard' %}" class="sidebar-link">
    <i class="bi bi-speedometer2"></i> Dashboard
</a>
<a href="{% url 'admin_upload_csv' %}" class="sidebar-link">
    <i class="bi bi-cloud-upload"></i> Upload CSV
</a>
<a href="{% url 'admin_manual_entry' %}" class="sidebar-link">
    <i class="bi bi-pencil-square"></i> Manual Entry
</a>
<a href="{% url 'admin_performance' %}" class="sidebar-link active">
    <i class="bi bi-graph-up-arrow"></i> Performance
</a>
{% endblock %}

{% block content %}
<div class="row g-4 mb-4">
    <!-- Bar Chart -->
    <div class="col-lg-8">
        <div class="card h-100">
            <div class="card-header"><i class="bi bi-bar-chart me-2" style="color:#6366f1;"></i>Average Marks by Subject
            </div>
            <div class="card-body">
                <canvas id="subjectAvgChart" height="200"></canvas>
            </div>
        </div>
    </div>

    <!-- Pie Chart -->
    <div class="col-lg-4">
        <div class="card h-100">
            <div class="card-header"><i class="bi bi-pie-chart me-2" style="color:#6366f1;"></i>Pass vs Fail Ratio</div>
            <div class="card-body d-flex flex-column align-items-center justify-content-center">
                <canvas id="passFailChart" style="max-height:230px;"></canvas>
                {% if pass_count is not None %}
                <div class="d-flex gap-3 mt-3">
                    <div class="text-center">
                        <div class="fw-700 text-success" style="font-size:1.5rem;">{{ pass_count }}</div>
                        <small class="text-muted">Passed</small>
                    </div>
                    <div class="text-center">
                        <div class="fw-700 text-danger" style="font-size:1.5rem;">{{ fail_count }}</div>
                        <small class="text-muted">Failed</small>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<div class="row g-4">
    <!-- Top Students -->
    <div class="col-lg-6">
        <div class="card h-100">
            <div class="card-header">
                <i class="bi bi-trophy me-2 text-warning"></i>Top Performing Students
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Student</th>
                                <th>Subject</th>
                                <th>Marks</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for s in top_students %}
                            <tr>
                                <td>
                                    {% if forloop.counter == 1 %}<span class="badge"
                                        style="background:#ffd700;color:#78350f;">ðŸ¥‡</span>
                                    {% elif forloop.counter == 2 %}<span class="badge"
                                        style="background:#c0c0c0;color:#374151;">ðŸ¥ˆ</span>
                                    {% elif forloop.counter == 3 %}<span class="badge"
                                        style="background:#cd7f32;color:#fff;">ðŸ¥‰</span>
                                    {% else %}{{ forloop.counter }}{% endif %}
                                </td>
                                <td><strong>{{ s.Student }}</strong></td>
                                <td><span class="badge badge-soft-primary">{{ s.Subject }}</span></td>
                                <td><strong class="text-success">{{ s.Marks }}</strong></td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="4" class="text-center py-4 text-muted">No data available.</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Weak Students -->
    <div class="col-lg-6">
        <div class="card h-100">
            <div class="card-header">
                <i class="bi bi-exclamation-triangle me-2 text-danger"></i>Needs Improvement
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Student</th>
                                <th>Subject</th>
                                <th>Marks</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for s in weak_students %}
                            <tr>
                                <td><strong>{{ s.Student }}</strong></td>
                                <td><span class="badge badge-soft-danger">{{ s.Subject }}</span></td>
                                <td><strong class="text-danger">{{ s.Marks }}</strong></td>
                                <td><span class="badge badge-soft-danger"><i class="bi bi-x-circle me-1"></i>Fail</span>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="4" class="text-center py-4 text-muted">ðŸŽ‰ All students passed!</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    const subjects = [{% for item in subject_averages %}"{{ item.Subject }}"{% if not forloop.last %}, {% endif %} {% endfor %}];
    const avgs = [{% for item in subject_averages %}{ { item.Average } } {% if not forloop.last %}, {% endif %} {% endfor %}];

    if (subjects.length > 0) {
        new Chart(document.getElementById('subjectAvgChart'), {
            type: 'bar',
            data: {
                labels: subjects,
                datasets: [{
                    label: 'Average Marks',
                    data: avgs,
                    backgroundColor: 'rgba(99,102,241,0.75)',
                    borderRadius: 8, borderSkipped: false,
                }]
            },
            options: {
                responsive: true,
                plugins: { legend: { display: false } },
                scales: {
                    y: { beginAtZero: true, max: 100, grid: { color: '#f1f5f9' } },
                    x: { grid: { display: false } }
                }
            }
        });
    }

    {% if pass_count is not None %}
    new Chart(document.getElementById('passFailChart'), {
        type: 'doughnut',
        data: {
            labels: ['Passed', 'Failed'],
            datasets: [{
                data: [{{ pass_count }}, {{ fail_count }}],
        backgroundColor: ['rgba(34,197,94,0.85)', 'rgba(239,68,68,0.85)'],
        borderWidth: 0,
    }]
    },
        options: {
        responsive: true,
        plugins: {
            legend: { position: 'bottom' },
            tooltip: { callbacks: { label: ctx => ` ${ctx.label}: ${ctx.raw}` } }
        },
        cutout: '65%',
    }
});
    {% endif %}
</script>
{% endblock %}